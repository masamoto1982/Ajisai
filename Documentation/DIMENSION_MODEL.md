# Ajisai 次元モデル仕様

## 次元制限

Ajisaiは最大4次元までのテンソルをサポートします：

| 軸 | インデックス | 意味 |
|----|-------------|------|
| time | 0 | 時間（時系列データ） |
| layer | 1 | 層（チャンネル、深さ） |
| row | 2 | 行 |
| col | 3 | 列 |

5次元以上のテンソルを作成しようとするとエラーになります。

```
[time, layer, row, col]
  0      1     2    3

1次元: [col]
2次元: [row, col]
3次元: [layer, row, col]
4次元: [time, layer, row, col]
```

## 基本概念

### 次元の定義
- 次元0: スカラー（単一の値）
- 次元1: ベクタ（値の列）
- 次元2: 行列（ベクタのベクタ）
- 次元N: N階テンソル

### 表記と次元の対応
| 表記 | 次元 | 名称 | 例 |
|------|------|------|-----|
| `5` | - | 裸の値（スタック上では`[5]`） | - |
| `[ 5 ]` | 0 | スカラー | 単一値 |
| `[ 1 2 3 ]` | 1 | ベクタ | 長さ3のベクタ |
| `[ [ 1 2 ] [ 3 4 ] ]` | 2 | 行列 | 2×2行列 |
| `[ [ [ 1 ] ] ]` | 3 | 3階テンソル | 1×1×1 |

### スタックの位置づけ
- スタック自体が暗黙の最外殻次元
- スタック上の各要素は独立したテンソル
- `..` モードはこの最外殻次元への操作

### 形状（Shape）
- 各次元のサイズを表すベクタ
- `[ 1 2 3 ]` の形状は `[ 3 ]`
- `[ [ 1 2 3 ] [ 4 5 6 ] ]` の形状は `[ 2 3 ]`

### 矩形制約
- 同一次元内の要素は同じ形状でなければならない
- `[ [ 1 2 ] [ 3 4 5 ] ]` は不正（行の長さが不一致）

## 次元の追加と削除

### 次元の追加
`[ ]` は新しい次元を追加する：

```ajisai
5           # スタック: [5] (長さ1のベクタ)
[ 5 ]       # スタック: [[5]] (スカラーを含む長さ1のベクタ)
[ 1 2 3 ]   # スタック: [[1, 2, 3]] (長さ3のベクタ)
```

### 次元の削除
- `LEVEL`: テンソルを1次元に平坦化
- `RESHAPE`: 形状を変更（次元数も変更可能）

## 数値の内部表現

すべての数値は分数（Fraction）として内部的に扱われる：

```ajisai
5           # Fraction(5, 1)
3/4         # Fraction(3, 4)
0.5         # Fraction(1, 2)
```

これにより、浮動小数点演算の丸め誤差を回避する。

## 演算のブロードキャスト

詳細は `BROADCASTING.md` を参照。

NumPy/APLと同様のブロードキャスト規則に従い、形状の異なるテンソル間の演算を可能にする。

## 軸（Axis）の概念

多次元テンソルの各次元は「軸」として参照される：

```
形状 [2, 3, 4] のテンソル:
- 軸 0: サイズ 2
- 軸 1: サイズ 3
- 軸 2: サイズ 4
```

軸を指定することで、特定の次元に沿った演算が可能：

```ajisai
[ [ 1 2 3 ] [ 4 5 6 ] ] '+' [ 0 ] ALONG  # 軸0（行方向）の合計
# → [ 6 15 ]

[ [ 1 2 3 ] [ 4 5 6 ] ] '+' [ 1 ] ALONG  # 軸1（列方向）の合計
# → [ 5 7 9 ]
```

## スカラー vs 1要素ベクタ

次元モデルでは、スカラーと1要素ベクタは区別される：

```ajisai
[ 5 ]       # 1要素ベクタ、形状 [1]
[ [ 5 ] ]   # スカラーを含むベクタ、形状 [1]、内部要素の形状 []
```

ただし、実装上の簡潔さのため、多くの場合は1要素ベクタとスカラーを同等に扱う。

## 現行システムとの互換性

### 維持される機能
- 分数演算システム
- オペレーションターゲット（`.` / `..`）
- ガード節（`:`）
- 高階関数（MAP/FILTER/REDUCE/FOLD/SCAN/UNFOLD）
- ワード定義（DEF/DEL/?）
- 基本演算（+/-/*/÷/比較/論理）

### 変更される機能
- `LEVEL`: 次元を潰す → 1次元に平坦化
- 文字列のベクタ内混在: 制限される可能性あり

### 新規追加される機能
- `SHAPE`: 形状を取得
- `RANK`: 次元数を取得
- `RESHAPE`: 形状を変更
- `TRANSPOSE`: 転置
- `ALONG`: 軸指定演算
- `OUTER`: 外積

## 括弧表示ルール

スタックエリア自体が暗黙の最外殻`[]`として機能します。
そのため、スタック上のテンソルは`{}`から始まります：

| 深さ | 括弧 | 説明 |
|------|------|------|
| 0 | [ ] | スタックエリア（暗黙、GUIの枠） |
| 1 | { } | テンソルの最外殻 |
| 2 | ( ) | 2番目の次元 |
| 3 | [ ] | 3番目の次元（サイクル） |
| 4 | { } | 4番目の次元（サイクル） |

### 表示例

```ajisai
# 1次元 [3]
{ 1 2 3 }

# 2次元 [2, 3]
{ ( 1 2 3 ) ( 4 5 6 ) }

# 3次元 [2, 2, 3]
{ ( [ 1 2 3 ] [ 4 5 6 ] ) ( [ 7 8 9 ] [ 10 11 12 ] ) }

# 4次元 [2, 2, 2, 3]
{ ( [ { 1 2 3 } { 4 5 6 } ] [ { ... } { ... } ] ) ( ... ) }
```

4次元で括弧が一巡し、5次元以上はエラーとなります。

### 入力と表示の分離

- **入力時**: `[]`, `{}`, `()` のいずれの括弧も同等に扱われる
- **表示時**: 深さに応じて自動的に適切な括弧に変換される

これにより、ユーザーは好みの括弧で入力でき、表示は常に一貫した形式になります。

## 設計上の注意点

1. **矩形制約の厳格化**: すべてのテンソルは矩形でなければならない
2. **型の明確化**: 数値テンソルと文字列/真偽値は明確に分離
3. **エラーメッセージの改善**: 形状不一致などを明確に報告
4. **パフォーマンス**: 大規模テンソルでも効率的に処理できるアルゴリズム選択
