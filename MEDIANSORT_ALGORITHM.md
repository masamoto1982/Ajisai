# MEDIANSORT - メディアントソートアルゴリズム

## 概要

**MEDIANSORT（メディアントソート）**は、分数の数学的性質である「メディアント」を利用した革新的なソートアルゴリズムです。Ajisaiにおいて全ての数値が内部的に分数として扱われる特性を最大限に活かした、世界初※の分数専用ソートアルゴリズムです。

※Ajisaiでの実装として

## メディアント（Mediant）とは

2つの分数 `a/b` と `c/d` のメディアント（中央分数）は以下のように定義されます：

```
mediant(a/b, c/d) = (a+c)/(b+d)
```

### 重要な数学的性質

**a/b < c/d のとき、常に a/b < (a+c)/(b+d) < c/d が成り立つ**

この性質により、メディアントは常に2つの分数の「間」に位置します。

### 具体例

```
1/3 と 2/3 のメディアント:
(1+2)/(3+3) = 3/6 = 1/2

確認: 1/3 ≈ 0.333 < 1/2 = 0.5 < 2/3 ≈ 0.667 ✓

1/2 と 3/4 のメディアント:
(1+3)/(2+4) = 4/6 = 2/3

確認: 1/2 = 0.5 < 2/3 ≈ 0.667 < 3/4 = 0.75 ✓
```

## アルゴリズムの革新性

### 1. 分数専用設計

従来のソートアルゴリズムは浮動小数点数への変換を前提としていますが、MEDIANSORTは分数を直接扱います：

- **精度の保持**: 浮動小数点への変換による精度損失なし
- **数学的正確性**: 分数の大小関係を正確に判定
- **Ajisaiとの親和性**: 内部表現を直接活用

### 2. 理想的なピボット選択

通常のクイックソートとの比較：

| | クイックソート | メディアントソート |
|---|---|---|
| ピボット選択 | 任意（先頭、末尾、ランダムなど） | 最小値と最大値のメディアント |
| 中央性の保証 | なし（最悪ケースで偏る可能性） | 数学的に保証された中央値 |
| 分数との親和性 | 低（浮動小数点変換が必要） | 高（分数演算を直接利用） |

メディアントを使用することで、ピボットが必ず範囲の「中央」に位置することが数学的に保証されます。

### 3. 数論との深い関連

MEDIANSORTは以下の数学的概念と密接に関連しています：

#### ファレイ数列（Farey Sequence）

分母がn以下の既約分数を昇順に並べた数列。隣接する分数のメディアントを追加することで次の数列を生成できます。

```
F₃ = {0/1, 1/3, 1/2, 2/3, 1/1}
F₄ = {0/1, 1/4, 1/3, 1/2, 2/3, 3/4, 1/1}

1/3 と 1/2 のメディアント = (1+1)/(3+2) = 2/5 → F₅に追加
```

#### シュテルン・ブロコ木（Stern-Brocot Tree）

すべての正の既約分数を一意に表現できる二分木。メディアント演算で構築されます：

```
           1/1
          /   \
       1/2     2/1
      /   \   /   \
    1/3  2/3 3/2  3/1
   ...
```

各ノードは親ノードと祖先のメディアントとして生成されます。

## アルゴリズムの詳細

### 擬似コード

```rust
function mediansort(items):
    if items.length <= 1:
        return items

    # 最小値と最大値を見つける
    min = find_minimum(items)
    max = find_maximum(items)

    if min == max:
        return items  # すべて同じ値

    # メディアント（理想的な中央値）を計算
    pivot = mediant(min, max)

    # 3方向分割
    left = [x for x in items if x < pivot]
    middle = [x for x in items if x == pivot]
    right = [x for x in items if x > pivot]

    # 再帰的にソート
    return mediansort(left) + middle + mediansort(right)
```

### 時間計算量

- **平均ケース**: O(n log n)
  - メディアントが理想的な中央値として機能する場合
  - バランスの良い分割が期待できる

- **最悪ケース**: O(n²)
  - 分割が極端に偏る場合
  - ただし、メディアントの性質により通常のクイックソートより発生しにくい

### 空間計算量

- **O(n)**: 再帰スタックと分割時のクローン

## 実装上の特徴

### Ajisaiでの実装

```rust
fn mediant(f1: &Fraction, f2: &Fraction) -> Fraction {
    let new_numerator = &f1.numerator + &f2.numerator;
    let new_denominator = &f1.denominator + &f2.denominator;
    Fraction::new(new_numerator, new_denominator)
}

fn mediansort_partition(items: &mut [(Fraction, Value)]) {
    if items.len() <= 1 {
        return;
    }

    // 最小値と最大値を検索
    let (min_idx, max_idx) = find_min_max_indices(items);

    if items[min_idx].0 == items[max_idx].0 {
        return;  // すべて同じ値
    }

    // メディアントを計算
    let pivot = mediant(&items[min_idx].0, &items[max_idx].0);

    // 3方向分割と再帰
    partition_and_recurse(items, pivot);
}
```

### STACKモード対応

Ajisaiの特徴である`STACK`/`STACKTOP`モードの両方に対応：

```ajisai
# StackTopモード（デフォルト）
[ 1/2 1/3 2/3 ] MEDIANSORT
# → [ 1/3 1/2 2/3 ]

# Stackモード
1/2 1/3 2/3 STACK MEDIANSORT
# → 1/3 1/2 2/3 (スタック全体がソートされる)
```

## 使用例

### 基本的な分数のソート

```ajisai
[ 1/2 1/3 2/3 1/4 3/4 ] MEDIANSORT
# → [ 1/4 1/3 1/2 2/3 3/4 ]
```

### 音楽理論：音程の比率

音程は周波数の比率で表されます。MEDIANSORTで正確にソート可能：

```ajisai
[ 3/2 4/3 5/4 2/1 9/8 ] MEDIANSORT
# → [ 9/8 5/4 4/3 3/2 2/1 ]

# 音程の意味:
# 9/8  = 長2度
# 5/4  = 長3度
# 4/3  = 完全4度
# 3/2  = 完全5度
# 2/1  = オクターブ
```

### πの近似値のソート

```ajisai
[ 22/7 355/113 3 ] MEDIANSORT
# → [ 3 22/7 355/113 ]

# 値の確認:
# 3       = 3.000000
# 22/7    ≈ 3.142857
# 355/113 ≈ 3.141593
# π       ≈ 3.141592653589793
```

### 整数と分数の混在

Ajisaiでは整数も分母が1の分数として扱われるため、自然に混在可能：

```ajisai
[ 2 1/2 3/2 1 5/2 ] MEDIANSORT
# → [ 1/2 1 3/2 2 5/2 ]

# 内部表現:
# 2   = 2/1
# 1/2 = 1/2
# 3/2 = 3/2
# 1   = 1/1
# 5/2 = 5/2
```

## 数学的背景の深堀り

### メディアントの驚くべき性質

1. **単調性**: a/b < c/d ならば a/b < (a+c)/(b+d) < c/d
2. **非可換性**: mediant(a/b, c/d) ≠ mediant(c/d, a/b) （一般には）
3. **既約性の保持**: a/b と c/d が既約で隣接するファレイ数なら、メディアントも既約

### ファレイ数列の生成

```
F₁ = {0/1, 1/1}

F₂ = {0/1, 1/2, 1/1}
     ↑   ↑メディアント(0/1, 1/1)

F₃ = {0/1, 1/3, 1/2, 2/3, 1/1}
          ↑            ↑
          メディアント(0/1, 1/2)とmediant(1/2, 1/1)

F₄ = {0/1, 1/4, 1/3, 1/2, 2/3, 3/4, 1/1}
```

### 連分数との関係

連分数展開とメディアント演算は密接に関連しており、MEDIANSORTは分数の「深さ」を考慮したソートとも解釈できます。

## 利点と欠点

### 利点

✅ **数学的美しさ**: 分数理論と深く結びついた優雅なアルゴリズム
✅ **精度保持**: 浮動小数点への変換なしに正確にソート
✅ **理想的なピボット**: 数学的に保証された中央値
✅ **教育的価値**: ファレイ数列、シュテルン・ブロコ木などの理解に有用
✅ **Ajisaiとの親和性**: 内部表現を直接活用

### 欠点

❌ **空間計算量**: O(n)の追加メモリが必要（インプレースではない）
❌ **最悪ケース**: O(n²)の可能性（ただし発生しにくい）
❌ **分数専用**: 他の型には適用不可
❌ **メディアントの約分**: 中間生成される分数の分母が大きくなる可能性

## 他のソートアルゴリズムとの比較

| アルゴリズム | 時間計算量（平均） | 空間計算量 | 安定性 | 分数特化 |
|---|---|---|---|---|
| BUBBLESORT | O(n²) | O(1) | 安定 | - |
| SELECTIONSORT | O(n²) | O(1) | 不安定 | - |
| QUICKSORT | O(n log n) | O(log n) | 不安定 | - |
| MERGESORT | O(n log n) | O(n) | 安定 | - |
| HEAPSORT | O(n log n) | O(1) | 不安定 | - |
| **MEDIANSORT** | **O(n log n)** | **O(n)** | **不安定** | **✓** |

## まとめ

MEDIANSORTは、分数の数学的性質を最大限に活用した画期的なソートアルゴリズムです。

**主な特徴:**
- 分数専用の設計
- メディアントによる理想的なピボット選択
- ファレイ数列やシュテルン・ブロコ木との深い関連
- 数学的に美しく教育的価値が高い

**適用場面:**
- 高精度な分数計算が必要な場合
- 音楽理論における周波数比の処理
- 数学的に正確なソート結果が求められる場合
- 分数理論の教育・学習

Ajisaiにおいて、全ての数値が分数として扱われるという特性を活かした、まさに「Ajisaiのための」ソートアルゴリズムと言えます。
