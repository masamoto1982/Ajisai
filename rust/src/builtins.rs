// rust/src/builtins.rs

use std::collections::{HashMap, HashSet};
use crate::types::WordDefinition;

pub fn register_builtins(dictionary: &mut HashMap<String, WordDefinition>) {
    for (name, description, _) in get_builtin_definitions() {
        dictionary.insert(name.to_string(), WordDefinition {
            lines: vec![],
            is_builtin: true,
            description: Some(description.to_string()),
            dependencies: HashSet::new(),
            original_source: None,
        });
    }
}

pub fn get_builtin_definitions() -> Vec<(&'static str, &'static str, &'static str)> {
    vec![
        // 入力支援
        ("'", "Insert single quote", "Input Helper"),
        ("[ ]", "Insert empty vector brackets", "Input Helper"),
        ("STACKTOP", "Insert STACKTOP keyword", "Input Helper"),
        ("STACK", "Insert STACK keyword", "Input Helper"),
        
        // 位置指定操作(0オリジン)
        ("GET", "Get element at position (0-indexed)", "Position"),
        ("INSERT", "Insert element at position", "Position"),
        ("REPLACE", "Replace element at position", "Position"),
        ("REMOVE", "Remove element at position", "Position"),
        
        // 量指定操作(1オリジン)
        ("LENGTH", "Get vector length", "Quantity"),
        ("TAKE", "Take first N elements", "Quantity"),
        
        // Vector構造操作
        ("SPLIT", "Splits a vector. With arguments, it splits into specified sizes. Without arguments, it slices into single-element vectors.", "Vector"),
        ("CONCAT", "Concatenate vectors. Default is 2. Specify count with an argument. Negative count reverses order.", "Vector"),
        ("REVERSE", "Reverse vector elements", "Vector"),
        ("LEVEL", "Flatten a nested vector", "Vector"),

        // 算術演算
        ("+", "Element-wise vector addition or Reduce N stack items.", "Arithmetic"),
        ("-", "Element-wise vector subtraction or Reduce N stack items.", "Arithmetic"),
        ("*", "Element-wise vector multiplication or Reduce N stack items.", "Arithmetic"),
        ("/", "Element-wise vector division or Reduce N stack items.", "Arithmetic"),
        
        // 比較演算
        ("=", "Vector equality test", "Comparison"),
        ("<", "Vector less than test", "Comparison"),
        ("<=", "Vector less than or equal test", "Comparison"),
        (">", "Vector greater than test", "Comparison"),
        (">=", "Vector greater than or equal test", "Comparison"),
        
        // 論理演算
        ("AND", "Vector logical AND", "Logic"),
        ("OR", "Vector logical OR", "Logic"),
        ("NOT", "Vector logical NOT", "Logic"),
        
        // 制御構造(ガード)
        (":", "Guard separator for conditional execution. Usage: condition : action : condition : action : default", "Control"),
        
        // 高階関数
        ("MAP", "Apply word to each element. Usage: [ data ] 'WORD' MAP or ... [ N ] 'WORD' STACK MAP", "Higher-Order"),
        ("FILTER", "Filter elements using word. Usage: [ data ] 'WORD' FILTER", "Higher-Order"),
        
        // 入出力
        ("PRINT", "Print top element", "I/O"),
        
        // カスタムワード管理
        ("DEF", "Define a custom word. Usage: (definition block) 'NAME' DEF", "Word Management"),
        ("DEL", "Delete a custom word. Usage: 'NAME' DEL", "Word Management"),
        ("?", "Look up word definition. Usage: 'NAME' ?", "Word Management"),
    ]
}

pub fn get_builtin_detail(name: &str) -> String {
    match name {
        // ============================================================================
        // 位置指定操作（0オリジン）
        // ============================================================================

        "GET" => r#"# GET - 指定位置の要素を取得

## 機能
ベクタまたはスタックから、指定した位置（0オリジン）の要素を取得します。
負のインデックスを使用すると、末尾から数えて要素を取得できます。

## 使用法（StackTopモード）
[ 要素... ] [ インデックス ] GET
→ 元のベクタを保持し、取得した要素を新しいベクタとしてプッシュ

## 使用法（Stackモード）
要素... [ インデックス ] STACK GET
→ スタック全体から指定位置の要素を取得

## 使用例
[ 10 20 30 ] [ 0 ] GET    # → [ 10 20 30 ] [ 10 ]  (0番目=最初の要素)
[ 10 20 30 ] [ 1 ] GET    # → [ 10 20 30 ] [ 20 ]  (1番目=2番目の要素)
[ 10 20 30 ] [ -1 ] GET   # → [ 10 20 30 ] [ 30 ]  (-1=末尾の要素)
[ 10 20 30 ] [ -2 ] GET   # → [ 10 20 30 ] [ 20 ]  (-2=末尾から2番目)

a b c [ 1 ] STACK GET     # → a b c [ b ]  (スタックの1番目を取得)

## 注意
- インデックスが範囲外の場合はエラー
- 空のベクタ/スタックに対する操作はエラー"#.to_string(),

        "INSERT" => r#"# INSERT - 指定位置に要素を挿入

## 機能
ベクタまたはスタックの指定位置（0オリジン）に要素を挿入します。
負のインデックスを使用すると、末尾から数えた位置に挿入できます。

## 使用法（StackTopモード）
[ 要素... ] [ インデックス ] [ 挿入する要素 ] INSERT
→ 指定位置に要素を挿入した新しいベクタを返す

## 使用法（Stackモード）
要素... [ インデックス ] 挿入する要素 STACK INSERT
→ スタックの指定位置に要素を挿入

## 使用例
[ 1 3 ] [ 1 ] [ 2 ] INSERT        # → [ 1 2 3 ]  (1番目の位置に2を挿入)
[ a c ] [ 0 ] [ b ] INSERT        # → [ b a c ]  (0番目=先頭に挿入)
[ 1 2 3 ] [ -1 ] [ 9 ] INSERT     # → [ 1 2 9 3 ]  (末尾の要素の前に挿入)
[ 1 2 3 ] [ 3 ] [ 4 ] INSERT      # → [ 1 2 3 4 ]  (末尾への追加も可能)

a c [ 1 ] b STACK INSERT          # → a b c  (スタックの1番目にbを挿入)

## 注意
- 単一要素ベクタは自動的にアンラップされます
- 負のインデックスは要素の位置を指します（-1=末尾の要素の位置）"#.to_string(),

        "REPLACE" => r#"# REPLACE - 指定位置の要素を置換

## 機能
ベクタまたはスタックの指定位置（0オリジン）の要素を新しい要素で置き換えます。

## 使用法（StackTopモード）
[ 要素... ] [ インデックス ] [ 新しい要素 ] REPLACE
→ 指定位置の要素を置換した新しいベクタを返す

## 使用法（Stackモード）
要素... [ インデックス ] 新しい要素 STACK REPLACE
→ スタックの指定位置の要素を置換

## 使用例
[ 1 2 3 ] [ 0 ] [ 9 ] REPLACE    # → [ 9 2 3 ]  (0番目=最初の要素を9に)
[ 1 2 3 ] [ 1 ] [ 5 ] REPLACE    # → [ 1 5 3 ]  (1番目=2番目の要素を5に)
[ 1 2 3 ] [ -1 ] [ 9 ] REPLACE   # → [ 1 2 9 ]  (-1=末尾を9に)

a b c [ 1 ] X STACK REPLACE      # → a X c  (スタックの1番目をXに)

## 注意
- インデックスが範囲外の場合はエラー
- 単一要素ベクタは自動的にアンラップされます"#.to_string(),

        "REMOVE" => r#"# REMOVE - 指定位置の要素を削除

## 機能
ベクタまたはスタックの指定位置（0オリジン）の要素を削除します。

## 使用法（StackTopモード）
[ 要素... ] [ インデックス ] REMOVE
→ 指定位置の要素を削除した新しいベクタを返す

## 使用法（Stackモード）
要素... [ インデックス ] STACK REMOVE
→ スタックの指定位置の要素を削除

## 使用例
[ 1 2 3 ] [ 0 ] REMOVE      # → [ 2 3 ]  (0番目=最初の要素を削除)
[ 1 2 3 ] [ 1 ] REMOVE      # → [ 1 3 ]  (1番目=2番目の要素を削除)
[ 1 2 3 ] [ -1 ] REMOVE     # → [ 1 2 ]  (-1=末尾を削除)
[ 1 2 3 4 ] [ -2 ] REMOVE   # → [ 1 2 4 ]  (-2=末尾から2番目を削除)

a b c [ 1 ] STACK REMOVE    # → a c  (スタックの1番目を削除)

## 注意
- インデックスが範囲外の場合はエラー"#.to_string(),

        // ============================================================================
        // 量指定操作（1オリジン）
        // ============================================================================

        "LENGTH" => r#"# LENGTH - 要素数を取得

## 機能
ベクタまたはスタック全体の要素数を取得します。

## 使用法（StackTopモード）
[ 要素... ] LENGTH
→ 元のベクタを保持し、要素数を新しいベクタとしてプッシュ

## 使用法（Stackモード）
要素... STACK LENGTH
→ スタック全体の要素数をプッシュ

## 使用例
[ 1 2 3 4 5 ] LENGTH    # → [ 1 2 3 4 5 ] [ 5 ]  (5個の要素)
[ ] LENGTH              # → [ ] [ 0 ]  (空ベクタは0)
[ 42 ] LENGTH           # → [ 42 ] [ 1 ]  (1個の要素)

a b c d STACK LENGTH    # → a b c d [ 4 ]  (スタックに4個)

## 注意
- StackTopモードでは対象がベクタでない場合はエラー"#.to_string(),

        "TAKE" => r#"# TAKE - 先頭または末尾から指定数の要素を取得

## 機能
正の数を指定すると先頭から、負の数を指定すると末尾から、
指定した個数の要素を取得します。

## 使用法（StackTopモード）
[ 要素... ] [ 個数 ] TAKE
→ 取得した要素からなる新しいベクタを返す

## 使用法（Stackモード）
要素... [ 個数 ] STACK TAKE
→ スタックを指定個数の要素に切り詰める

## 使用例
[ 1 2 3 4 5 ] [ 3 ] TAKE     # → [ 1 2 3 ]  (先頭から3個)
[ 1 2 3 4 5 ] [ -2 ] TAKE    # → [ 4 5 ]  (末尾から2個)
[ 1 2 3 4 5 ] [ 1 ] TAKE     # → [ 1 ]  (先頭1個)

a b c d e [ 3 ] STACK TAKE   # → a b c  (先頭3個だけ残す)
a b c d e [ -2 ] STACK TAKE  # → d e  (末尾2個だけ残す)

## 注意
- 指定個数が要素数を超える場合はエラー
- 0を指定した場合の動作は未定義"#.to_string(),

        "SPLIT" => r#"# SPLIT - 指定サイズで分割

## 機能
ベクタまたはスタックを、指定したサイズに分割します。
複数のサイズを指定でき、余りは最後のベクタに含まれます。

## 使用法（StackTopモード）
[ 要素... ] [ サイズ1 ] [ サイズ2 ] ... SPLIT
→ 分割された複数のベクタをプッシュ

## 使用法（Stackモード）
要素... [ サイズ1 ] [ サイズ2 ] ... STACK SPLIT
→ スタックを分割し、結果をベクタとしてプッシュ

## 使用例
[ 1 2 3 4 5 6 ] [ 2 ] [ 3 ] [ 1 ] SPLIT
# → [ 1 2 ] [ 3 4 5 ] [ 6 ]  (2個、3個、1個に分割)

[ 1 2 3 4 5 6 ] [ 2 ] [ 2 ] SPLIT
# → [ 1 2 ] [ 3 4 ] [ 5 6 ]  (余りも自動的にベクタに)

a b c d e [ 2 ] [ 1 ] STACK SPLIT
# → [ a b ] [ c ] [ d e ]  (スタックを分割)

## 注意
- サイズの合計が要素数を超える場合はエラー
- 最低1つのサイズ指定が必要"#.to_string(),

        // ============================================================================
        // ベクタ構造操作
        // ============================================================================

        "CONCAT" => r#"# CONCAT - ベクタを連結

## 機能
複数のベクタを1つに連結します。
デフォルトは2個、個数を指定可能。負数で逆順連結。

## 使用法（StackTopモード）
vec1 vec2 CONCAT              # 2個を連結（デフォルト）
vec1 vec2 vec3 [ 3 ] CONCAT   # 3個を連結
vec1 vec2 vec3 [ -3 ] CONCAT  # 3個を逆順で連結

## 使用法（Stackモード）
要素... STACK CONCAT          # スタック全体を連結
要素... [ 個数 ] STACK CONCAT # 指定個数を連結

## 使用例
[ a ] [ b ] CONCAT                # → [ a b ]  (デフォルト2個)
[ a ] [ b ] [ c ] [ 3 ] CONCAT    # → [ a b c ]  (3個を連結)
[ a ] [ b ] [ c ] [ -3 ] CONCAT   # → [ c b a ]  (逆順)
[ 1 ] [ 2 3 ] [ 4 ] [ 3 ] CONCAT  # → [ 1 2 3 4 ]

a b c STACK CONCAT                # → [ a b c ]  (全体を連結)
a b c [ 2 ] STACK CONCAT          # → a [ b c ]  (2個だけ連結)

## 注意
- ベクタでない要素も単独要素として含まれます
- 最初のベクタの括弧タイプが結果に適用されます"#.to_string(),

        "REVERSE" => r#"# REVERSE - 要素の順序を反転

## 機能
ベクタまたはスタックの要素順序を反転します。
「変化なしはエラー」原則により、要素が2個未満や回文の場合はエラー。

## 使用法（StackTopモード）
[ 要素... ] REVERSE
→ 要素順を反転した新しいベクタを返す

## 使用法（Stackモード）
要素... STACK REVERSE
→ スタックの要素順を反転

## 使用例
[ a b c ] REVERSE      # → [ c b a ]
[ 1 2 3 4 ] REVERSE    # → [ 4 3 2 1 ]

a b c STACK REVERSE    # → c b a

## エラーケース
[ 1 ] REVERSE          # エラー：1要素のみ（変化なし）
[ a b a ] REVERSE      # エラー：回文（変化なし）
[ ] REVERSE            # エラー：空ベクタ（変化なし）

## 注意
- 変化が生じない場合は必ずエラーになります"#.to_string(),

        "LEVEL" => r#"# LEVEL - ネストされたベクタを平坦化

## 機能
ネストされたベクタをすべて展開し、1次元のベクタにします。
「変化なしはエラー」原則により、すでに平坦な場合はエラー。

## 使用法（StackTopモード）
[ ネストされた要素... ] LEVEL
→ すべてのネストを解消した平坦なベクタを返す

## 使用法（Stackモード）
要素... STACK LEVEL
→ スタック内のベクタをすべて展開

## 使用例
[ [ a b ] [ c ] ] LEVEL        # → [ a b c ]
[ [ 1 ] [ [ 2 ] 3 ] ] LEVEL    # → [ 1 2 3 ]  (再帰的に展開)
[ [ a ] b [ c d ] ] LEVEL      # → [ a b c d ]

[ a ] [ b ] [ c ] STACK LEVEL  # → a b c  (ベクタを展開)

## エラーケース
[ a b c ] LEVEL                # エラー：すでに平坦（変化なし）
a b c STACK LEVEL              # エラー：ベクタがない（変化なし）

## 注意
- すべてのネストレベルが再帰的に展開されます"#.to_string(),

        // ============================================================================
        // 算術演算
        // ============================================================================

        "+" => r#"# + - 加算

## 機能（StackTopモード）
2つのベクタの要素ごとの加算を行います。
片方が単一要素の場合、ブロードキャスト（全要素に適用）されます。

## 機能（Stackモード）
スタックから指定個数の要素を取得し、左から右へ順に加算します。

## 使用法（StackTopモード）
[ 要素... ] [ 要素... ] +
→ 要素ごとに加算した新しいベクタ

## 使用法（Stackモード）
要素... [ 個数 ] STACK +
→ 指定個数の要素を加算した結果

## 使用例（StackTopモード）
[ 1 2 3 ] [ 4 5 6 ] +      # → [ 5 7 9 ]  (要素ごと)
[ 1 2 3 ] [ 10 ] +         # → [ 11 12 13 ]  (ブロードキャスト)
[ 5 ] [ 1 2 3 ] +          # → [ 6 7 8 ]  (逆向きブロードキャスト)

## 使用例（Stackモード）
[ 1 ] [ 2 ] [ 3 ] [ 3 ] STACK +   # → [ 6 ]  (1+2+3)
[ 10 ] [ 5 ] [ 2 ] STACK +        # → [ 12 ]  (10+5、デフォルト2個)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー
- 演算結果が入力と同じ場合（例：[0]との加算）はエラー"#.to_string(),

        "-" => r#"# - - 減算

## 機能（StackTopモード）
2つのベクタの要素ごとの減算を行います。
片方が単一要素の場合、ブロードキャスト（全要素に適用）されます。

## 機能（Stackモード）
スタックから指定個数の要素を取得し、左から右へ順に減算します。

## 使用法（StackTopモード）
[ 要素... ] [ 要素... ] -
→ 要素ごとに減算した新しいベクタ

## 使用法（Stackモード）
要素... [ 個数 ] STACK -
→ 指定個数の要素を減算した結果

## 使用例（StackTopモード）
[ 5 7 9 ] [ 1 2 3 ] -      # → [ 4 5 6 ]  (要素ごと)
[ 10 20 30 ] [ 5 ] -       # → [ 5 15 25 ]  (ブロードキャスト)
[ 100 ] [ 1 2 3 ] -        # → [ 99 98 97 ]  (逆向きブロードキャスト)

## 使用例（Stackモード）
[ 10 ] [ 3 ] [ 2 ] [ 3 ] STACK -  # → [ 5 ]  (10-3-2)
[ 100 ] [ 25 ] [ 2 ] STACK -      # → [ 75 ]  (100-25)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー
- 演算結果が入力と同じ場合（例：[0]との減算）はエラー"#.to_string(),

        "*" => r#"# * - 乗算

## 機能（StackTopモード）
2つのベクタの要素ごとの乗算を行います。
片方が単一要素の場合、ブロードキャスト（全要素に適用）されます。

## 機能（Stackモード）
スタックから指定個数の要素を取得し、左から右へ順に乗算します。

## 使用法（StackTopモード）
[ 要素... ] [ 要素... ] *
→ 要素ごとに乗算した新しいベクタ

## 使用法（Stackモード）
要素... [ 個数 ] STACK *
→ 指定個数の要素を乗算した結果

## 使用例（StackTopモード）
[ 1 2 3 ] [ 4 5 6 ] *      # → [ 4 10 18 ]  (要素ごと)
[ 1 2 3 ] [ 10 ] *         # → [ 10 20 30 ]  (ブロードキャスト)
[ 5 ] [ 2 3 4 ] *          # → [ 10 15 20 ]  (逆向きブロードキャスト)

## 使用例（Stackモード）
[ 2 ] [ 3 ] [ 4 ] [ 3 ] STACK *   # → [ 24 ]  (2*3*4)
[ 5 ] [ 6 ] [ 2 ] STACK *         # → [ 30 ]  (5*6)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー
- 演算結果が入力と同じ場合（例：[1]との乗算）はエラー"#.to_string(),

        "/" => r#"# / - 除算

## 機能（StackTopモード）
2つのベクタの要素ごとの除算を行います。
片方が単一要素の場合、ブロードキャスト（全要素に適用）されます。
結果は分数として正確に保持されます。

## 機能（Stackモード）
スタックから指定個数の要素を取得し、左から右へ順に除算します。

## 使用法（StackTopモード）
[ 要素... ] [ 要素... ] /
→ 要素ごとに除算した新しいベクタ

## 使用法（Stackモード）
要素... [ 個数 ] STACK /
→ 指定個数の要素を除算した結果

## 使用例（StackTopモード）
[ 10 20 30 ] [ 2 4 5 ] /   # → [ 5 5 6 ]  (要素ごと)
[ 10 20 30 ] [ 10 ] /      # → [ 1 2 3 ]  (ブロードキャスト)
[ 100 ] [ 2 4 5 ] /        # → [ 50 25 20 ]  (逆向きブロードキャスト)

## 使用例（Stackモード）
[ 100 ] [ 2 ] [ 5 ] [ 3 ] STACK /  # → [ 10 ]  (100/2/5)
[ 20 ] [ 4 ] [ 2 ] STACK /         # → [ 5 ]  (20/4)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー
- 0での除算はエラー
- 演算結果が入力と同じ場合（例：[1]での除算）はエラー"#.to_string(),

        // ============================================================================
        // 比較演算
        // ============================================================================

        "=" => r#"# = - 等価比較

## 機能
2つのベクタの要素ごとに等価比較を行います。
要素数が等しい場合は要素ごとに比較、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] =
→ 各要素の比較結果（true/false）のベクタ

## 使用例
[ 1 2 3 ] [ 1 2 4 ] =      # → [ true true false ]
[ 5 5 5 ] [ 5 ] =          # → [ true true true ]  (ブロードキャスト)
[ a b c ] [ a b c ] =      # → [ true true true ]

## 注意
- ベクタ全体の比較ではなく、要素ごとの比較です
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー"#.to_string(),

        "<" => r#"# < - 小なり比較

## 機能
2つのベクタの要素ごとに「左 < 右」を比較します。
要素数が等しい場合は要素ごとに比較、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] <
→ 各要素の比較結果（true/false）のベクタ

## 使用例
[ 1 2 3 ] [ 2 2 2 ] <      # → [ true false false ]
[ 1 2 3 ] [ 3 ] <          # → [ true true false ]  (ブロードキャスト)
[ 5 ] [ 1 2 3 4 5 ] <      # → [ false false false false false ]

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー"#.to_string(),

        "<=" => r#"# <= - 小なりイコール比較

## 機能
2つのベクタの要素ごとに「左 <= 右」を比較します。
要素数が等しい場合は要素ごとに比較、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] <=
→ 各要素の比較結果（true/false）のベクタ

## 使用例
[ 1 2 3 ] [ 2 2 2 ] <=     # → [ true true false ]
[ 1 2 3 ] [ 3 ] <=         # → [ true true true ]  (ブロードキャスト)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー"#.to_string(),

        ">" => r#"# > - 大なり比較

## 機能
2つのベクタの要素ごとに「左 > 右」を比較します。
要素数が等しい場合は要素ごとに比較、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] >
→ 各要素の比較結果（true/false）のベクタ

## 使用例
[ 3 2 1 ] [ 2 2 2 ] >      # → [ true false false ]
[ 5 4 3 ] [ 3 ] >          # → [ true true false ]  (ブロードキャスト)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー"#.to_string(),

        ">=" => r#"# >= - 大なりイコール比較

## 機能
2つのベクタの要素ごとに「左 >= 右」を比較します。
要素数が等しい場合は要素ごとに比較、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] >=
→ 各要素の比較結果（true/false）のベクタ

## 使用例
[ 3 2 1 ] [ 2 2 2 ] >=     # → [ true true false ]
[ 5 4 3 ] [ 3 ] >=         # → [ true true true ]  (ブロードキャスト)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー"#.to_string(),

        // ============================================================================
        // 論理演算
        // ============================================================================

        "AND" => r#"# AND - 論理積

## 機能
2つのベクタの要素ごとに論理積（AND）を計算します。
要素数が等しい場合は要素ごとに演算、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] AND
→ 各要素の論理積のベクタ

## 使用例
[ true true false false ] [ true false true false ] AND
# → [ true false false false ]

[ true false true ] [ true ] AND
# → [ true false true ]  (ブロードキャスト)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー
- 要素はboolean型である必要があります"#.to_string(),

        "OR" => r#"# OR - 論理和

## 機能
2つのベクタの要素ごとに論理和（OR）を計算します。
要素数が等しい場合は要素ごとに演算、片方が単一要素の場合はブロードキャスト。

## 使用法
[ 要素... ] [ 要素... ] OR
→ 各要素の論理和のベクタ

## 使用例
[ true true false false ] [ true false true false ] OR
# → [ true true true false ]

[ true false true ] [ false ] OR
# → [ true false true ]  (ブロードキャスト)

## 注意
- ベクタの長さが異なる場合（ブロードキャスト以外）はエラー
- 要素はboolean型である必要があります"#.to_string(),

        "NOT" => r#"# NOT - 論理否定

## 機能
ベクタの各要素の論理否定（NOT）を計算します。

## 使用法
[ 要素... ] NOT
→ 各要素を否定したベクタ

## 使用例
[ true false true ] NOT    # → [ false true false ]
[ false ] NOT              # → [ true ]

## 注意
- 要素はboolean型である必要があります"#.to_string(),

        // ============================================================================
        // 制御構造
        // ============================================================================

        ":" => r#"# : - ガード区切り（条件分岐）

## 機能
条件による分岐を実現します。
「条件 : アクション : 条件 : アクション : デフォルト」の形式で使用します。

## 使用法
条件1 : アクション1 : 条件2 : アクション2 : ... : デフォルトアクション

## 動作
- 左から順に条件を評価
- 最初にtrueになった条件のアクションを実行
- すべての条件がfalseの場合、デフォルトアクションを実行

## 使用例
# 値が正か負かゼロかを判定
[ 5 ] [ 0 ] > : 'positive' : [ 5 ] [ 0 ] < : 'negative' : 'zero'
# → 'positive' (5 > 0がtrue)

# 単純なif-else
[ x ] [ 10 ] > : '大きい' : '小さいか等しい'

## 注意
- 条件は真偽値（true/false）を返す式である必要があります
- コロンの数は奇数個になります（条件:アクション:条件:アクション:デフォルト）"#.to_string(),

        // ============================================================================
        // 高階関数
        // ============================================================================

        "MAP" => r#"# MAP - 各要素に関数を適用

## 機能
ベクタまたはスタックの各要素に対して、指定したワードを適用します。

## 使用法（StackTopモード）
[ 要素... ] 'WORD' MAP
→ 各要素にWORDを適用した結果のベクタ

## 使用法（Stackモード）
要素... [ 個数 ] 'WORD' STACK MAP
→ 指定個数の要素にWORDを適用

## 使用例
[ 1 2 3 4 ] '[ 2 ] *' MAP
# → [ 2 4 6 8 ]  (各要素を2倍)

[ 1 2 3 ] '[ 1 ] +' MAP
# → [ 2 3 4 ]  (各要素に1を加算)

# カスタムワードを使用
[ '[ 2 ] * [ 1 ] +' ] 'DOUBLE_PLUS_ONE' DEF
[ 1 2 3 ] 'DOUBLE_PLUS_ONE' MAP
# → [ 3 5 7 ]  (各要素を2倍して1を足す)

## 注意
- ワード名はシングルクォート文字列で指定
- 各要素に対して独立して実行されます"#.to_string(),

        "FILTER" => r#"# FILTER - 条件に合う要素を抽出

## 機能
ベクタの各要素に対して条件ワードを適用し、
trueを返した要素のみを残します。

## 使用法
[ 要素... ] 'WORD' FILTER
→ 条件を満たす要素のみのベクタ

## 使用例
[ 1 2 3 4 5 6 ] '[ 2 ] [ 0 ] = NOT' FILTER
# → [ 1 3 5 ]  (奇数のみ抽出)

[ 10 5 20 3 15 ] '[ 10 ] >' FILTER
# → [ 20 15 ]  (10より大きい要素)

# カスタムワードを使用
[ '[ 5 ] >' ] 'IS_LARGE' DEF
[ 1 3 8 2 7 ] 'IS_LARGE' FILTER
# → [ 8 7 ]  (5より大きい要素)

## 注意
- ワード名はシングルクォート文字列で指定
- 条件ワードはtrue/falseを返す必要があります"#.to_string(),

        // ============================================================================
        // 入出力
        // ============================================================================

        "PRINT" => r#"# PRINT - 要素を出力

## 機能
スタックトップの要素を出力バッファに書き込みます。
要素はスタックから除去されます。

## 使用法
要素 PRINT
→ 要素を出力し、スタックから削除

## 使用例
[ 42 ] PRINT              # 出力: 42
'Hello' PRINT             # 出力: Hello
[ 1 2 3 ] PRINT           # 出力: [1 2 3]

# 複数の値を出力
[ 1 ] [ 2 ] [ 3 ]
PRINT PRINT PRINT         # 出力: 1 2 3

## 注意
- 出力後、要素はスタックから削除されます
- 出力フォーマットは要素の型によって自動的に決定されます"#.to_string(),

        // ============================================================================
        // ワード管理
        // ============================================================================

        "DEF" => r#"# DEF - カスタムワードを定義

## 機能
新しいカスタムワードを定義し、辞書に登録します。

## 使用法
[ '定義内容' ] 'NAME' DEF               # 説明なし
[ '定義内容' ] 'NAME' '説明' DEF       # 説明あり

## 使用例
# 単純なワード定義
[ '[ 2 ] *' ] 'DOUBLE' DEF
[ 5 ] DOUBLE                # → [ 10 ]

# 複数行の定義（改行を含む）
[ '[ 1 ] +
  [ 2 ] *' ] 'INC_AND_DOUBLE' DEF
[ 5 ] INC_AND_DOUBLE        # → [ 12 ]  ((5+1)*2)

# 説明付きの定義
[ '[ 3 ] *' ] 'TRIPLE' '値を3倍にする' DEF
'TRIPLE' ?                  # 説明が表示される

## 注意
- ワード名は自動的に大文字に変換されます
- 組み込みワードは上書きできません
- 既存のカスタムワードは上書きされます
- 定義内容はシングルクォート文字列で指定します"#.to_string(),

        "DEL" => r#"# DEL - カスタムワードを削除

## 機能
辞書からカスタムワードを削除します。

## 使用法
'NAME' DEL
→ 指定したワードを辞書から削除

## 使用例
# ワードを定義して削除
[ '[ 2 ] *' ] 'DOUBLE' DEF
'DOUBLE' DEL                # DOUBLEが削除される

# 削除後は使用不可
[ 5 ] DOUBLE                # エラー: Unknown word

## 注意
- 組み込みワードは削除できません
- 存在しないワードを削除しようとするとエラー
- ワード名は自動的に大文字に変換されます"#.to_string(),

        "?" => r#"# ? - ワード定義を参照

## 機能
ワードの定義や説明をInputエリアに呼び出します。

## 使用法
'NAME' ?
→ ワードの定義をInputエリアに読み込み

## 動作
【組み込みワードの場合】
- 詳細な説明、使用法、使用例が表示されます
- 機能、構文、注意事項などの情報が含まれます

【カスタムワードの場合】
- 定義時の記述がそのまま表示されます
- 改行、#コメントなども含めて完全に再現されます
- DEF文として呼び出されるため、再定義が簡単です

## 使用例
'GET' ?                     # GETの詳細な説明が表示される
'DOUBLE' ?                  # DOUBLEの定義が表示される

# カスタムワードの定義を確認して修正
[ '[ 2 ] *' ] 'DOUBLE' DEF
'DOUBLE' ?                  # [ '[ 2 ] *' ] 'DOUBLE' DEF
# ↑ Inputエリアに読み込まれるので、編集して再定義可能

## 注意
- ワード名は自動的に大文字に変換されます
- 存在しないワードを参照するとエラー"#.to_string(),

        // ============================================================================
        // 入力支援
        // ============================================================================

        "'" => r#"# ' - シングルクォート挿入

## 機能
Inputエリアにシングルクォート(')を挿入します。
入力支援のための便利機能です。

## 使用法
ボタンをクリックすると、カーソル位置にシングルクォートが挿入されます。

## 使用例
キーボード入力: [  ]  →  ボタン「'」クリック  →  [ '' ]
（カーソルがクォートの間に配置されます）

## 注意
- これは実行可能なワードではなく、入力支援機能です"#.to_string(),

        "[ ]" => r#"# [ ] - 空ベクタ挿入

## 機能
Inputエリアに空ベクタの括弧 [ ] を挿入します。
入力支援のための便利機能です。

## 使用法
ボタンをクリックすると、カーソル位置に [ ] が挿入されます。

## 使用例
ボタン「[ ]」クリック  →  [ ]
（カーソルが括弧の間に配置されます）

## 注意
- これは実行可能なワードではなく、入力支援機能です"#.to_string(),

        "STACKTOP" => r#"# STACKTOP - StackTopモード指定

## 機能
Inputエリアに "STACKTOP" キーワードを挿入します。
入力支援のための便利機能です。

## 動作
StackTopモードでは、操作対象はスタックトップのベクタになります。

## 使用例
通常の操作（デフォルトはStackTopモード）:
[ 1 2 3 ] [ 1 ] GET    # → [ 1 2 3 ] [ 2 ]

## 注意
- これは入力支援ボタンです
- デフォルトモードがStackTopなので、通常は明示的な指定は不要です"#.to_string(),

        "STACK" => r#"# STACK - Stackモード指定

## 機能
Inputエリアに "STACK" キーワードを挿入します。
操作対象をスタック全体に切り替えます。

## 動作
Stackモードでは、操作対象はスタック全体になります。
多くの組み込みワードがStackモードに対応しています。

## 使用例
a b c [ 1 ] STACK GET      # → a b c [ b ]
（スタック全体から1番目を取得）

1 2 3 4 5 STACK LENGTH     # → 1 2 3 4 5 [ 5 ]
（スタックの要素数を取得）

a b c STACK REVERSE        # → c b a
（スタック全体を反転）

## 対応ワード
GET, INSERT, REPLACE, REMOVE, LENGTH, TAKE, SPLIT,
CONCAT, REVERSE, LEVEL, +, -, *, /, MAP など

## 注意
- これは入力支援ボタンですが、実行時には動作モードを切り替えます"#.to_string(),

        _ => {
            // 既存の定義情報にフォールバック
            let definitions = get_builtin_definitions();
            for (word_name, description, category) in definitions {
                if word_name == name {
                    return format!("# {} - {}\n\nCategory: {}\n\n## 説明\n{}\n\n詳細な説明は未実装です。",
                        name, description, category, description);
                }
            }
            format!("ワード '{}' の詳細情報はありません。", name)
        }
    }.to_string()
}
