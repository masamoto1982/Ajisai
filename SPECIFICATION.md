# Ajisai 言語仕様書

**バージョン:** v0.2.0
**ステータス:** 既存ドキュメント統合完了、対話を通じて段階的に拡充する

---

## 1. Ajisaiとは

Ajisaiは**Vector指向プログラミング言語**である。

植物学におけるアジサイの学名 *Hydrangea* は、ギリシア語の *hydor*（水）と *angos*（容器）に由来する。「水の容器」というこの語源が、Ajisaiのアーキテクチャの本質を表している。

- データは「水」: 内部的にすべての値は `Vec<Fraction>`（分数の配列）として存在する
- 型は「波紋」: 表示時の解釈（DisplayHint）に過ぎず、演算には関与しない
- 形状は「容器」: 次元構造（shape）がデータの形を規定する

FORTHから継承したのは**後置記法**と**辞書システム**のみである。データ構造の中心はスタックではなく**Vector**であり、FORTH的なスタック操作（DUP, SWAP, ROT, OVER等）は存在しない。

---

## 2. コア特性

### 2.1 Vector指向

すべてのデータ構造の中心はVectorである。スタックは「暗黙の0次元Vector」として機能するが、言語の設計思想はスタック操作ではなく、Vectorに対する変換と写像に基づく。

### 2.2 統一分数アーキテクチャ（Unified Fraction Architecture）

すべての値は内部的に分数（Fraction）として表現される。型システムは存在しない。

```rust
pub struct Value {
    pub data: Vec<Fraction>,       // 水（唯一の真実）
    pub display_hint: DisplayHint, // 波紋（表示時の解釈）
    pub shape: Vec<usize>,         // 容器（次元構造）
}
```

| フィールド | 役割 | 演算への影響 |
|-----------|------|-------------|
| `data` | 実際のデータ（分数配列） | 唯一の計算対象 |
| `display_hint` | 表示形式のヒント | なし（表示時のみ参照） |
| `shape` | 多次元配列の形状 | RESHAPE等の形状操作のみ |

#### 内部表現

| ユーザーから見える姿 | 内部表現 | 説明 |
|---------------------|---------|------|
| `42` | `[42/1]` | 整数は分数 |
| `1/3` | `[1/3]` | 分数リテラル |
| `0.5` | `[1/2]` | 小数は分数に変換 |
| `TRUE` | `[1/1]` | 1が真、0が偽 |
| `'A'` | `[65/1]` | 文字コード（Unicode） |
| `'Hello'` | `[72/1, 101/1, ...]` | 文字コードの配列 |
| `NIL` | `[0/0]` | センチネル値 |
| `[ ]` | --- | エラー（空ブラケットは禁止） |

#### Fraction型

```rust
pub struct Fraction {
    pub numerator: BigInt,   // 分子（任意精度）
    pub denominator: BigInt, // 分母（任意精度）
}
```

- 任意精度: `num-bigint` クレートによる無制限精度
- 自動簡約: GCD計算により常に最簡形を維持
- サポートする数値形式: 整数（`42`）、小数（`1.5`）、分数（`1/3`）、指数（`1e10`）

#### DisplayHint

`DisplayHint` は表示専用の情報であり、演算には一切使用しない。

```rust
pub enum DisplayHint {
    Auto,      // 自動判定
    Number,    // 数値として表示
    String,    // 文字列として表示
    Boolean,   // 真偽値として表示
    DateTime,  // 日時として表示
    Nil,       // NILとして表示
}
```

重要な原則:

1. 演算は `data` のみを参照する。`display_hint` は無視される
2. 表示時のみ `display_hint` を参照し、フォーマットを決定する
3. 形式変換ワード（STR, NUM, BOOL等）は `display_hint` を変更する。`data` は必要に応じて変換される

### 2.3 「3」の原則

Ajisaiは一貫した「3」の制限に基づいて設計されている。

| 制限 | 値 | 説明 |
|------|-----|------|
| 可視次元 | 3 | `{ ( [ ] ) }` まで |
| 呼び出し深度 | 3 | `A -> B -> C` まで |

これらの制限はAjisaiの設計の核心であり、緩和の対象ではない。

#### 呼び出し深度制限

名前付きワード（カスタムワード）の呼び出し深度は最大3に制限される。

```ajisai
# 深度3: 正常動作
# MAIN -> HELPER -> INNER
: INNER ; 'HELPER' DEF
: HELPER ; 'MAIN' DEF

# 深度4: エラー
# A -> B -> C -> D
# -> Call depth limit (3) exceeded: A -> B -> C -> D
```

制限の対象:

- カスタムワード同士の呼び出しチェーンのみカウントされる
- 組み込みワード（`+`, `MAP`, `FOLD`等）は深度カウントに含まれない
- 高階関数内でのワード呼び出しは、その時点の深度からカウントされる
- 直接再帰も深度制限の対象となる

深い再帰の代わりに高階関数（MAP, FILTER, FOLD）の使用を推奨する。

### 2.4 次元モデル

| 次元 | 括弧 | 可視性 | 役割 |
|------|------|--------|------|
| 0次元 | `[ ]` | 不可視 | スタック（暗黙の最外殻Vector） |
| 1次元 | `{ }` | 可視 | 最外殻 |
| 2次元 | `( )` | 可視 | 2番目のネスト |
| 3次元 | `[ ]` | 可視 | 最深のネスト（限界） |
| 4次元以降 | --- | --- | エラー |

4次元以上を作成しようとした場合:

```
Dimension limit exceeded: Ajisai supports up to 3 visible dimensions
(plus dimension 0: the stack). Nesting depth 4 exceeds the limit.
```

#### 括弧表示規則

入力時は `[]`, `{}`, `()` のいずれも同等に扱われる。表示時に深さに応じた括弧に自動変換される。

```ajisai
# 入力 -> 表示
[ 1 2 3 ]                          # -> { 1 2 3 }
[ [ 1 2 ] [ 3 4 ] ]                # -> { ( 1 2 ) ( 3 4 ) }
[ [ [ 1 2 ] [ 3 4 ] ] [ [ 5 6 ] [ 7 8 ] ] ]
                                    # -> { ( [ 1 2 ] [ 3 4 ] ) ( [ 5 6 ] [ 7 8 ] ) }
```

複数のVectorがスタック上にある場合、各Vectorは独立して `{}` から始まる:

```ajisai
[ 1 2 ] [ 3 4 ]                    # -> { 1 2 }  { 3 4 }
```

#### 形状（Shape）

各次元のサイズを表すVectorである。

```ajisai
{ 1 2 3 }                          # 形状: { 3 }
{ ( 1 2 3 ) ( 4 5 6 ) }            # 形状: { 2 3 }
```

#### 矩形制約

同一次元内の要素は同じ形状でなければならない。

```ajisai
{ ( 1 2 ) ( 3 4 ) }                # 正当: 各行が長さ2
{ ( 1 2 ) ( 3 4 5 ) }              # エラー: 行の長さが不一致
```

### 2.5 ブロードキャスト

NumPy/APL と同様のブロードキャスト規則を採用する。形状の異なるテンソル間の演算を自動的な形状調整により可能にする。

#### 規則

1. **形状の比較は右から行う**
2. **各次元は以下の場合に互換**: サイズが同じ、またはどちらかが1
3. **足りない次元は左に1を追加して補う**
4. **サイズが1の次元は、必要に応じて拡張される**

```
形状 [2, 3] と [3] の比較:
  [2, 3]
     [3]    <- [1, 3] として扱う
  ------
  [2, 3]   <- 結果の形状
```

#### 具体例

```ajisai
# スカラーとVector
[ 5 ] [ 1 2 3 ] +                  # -> [ 6 7 8 ]

# Vectorと行列（行方向ブロードキャスト）
[ [ 1 2 3 ] [ 4 5 6 ] ] [ 10 20 30 ] +
                                    # -> [ [ 11 22 33 ] [ 14 25 36 ] ]

# 列Vectorと行列（列方向ブロードキャスト）
[ [ 1 2 3 ] [ 4 5 6 ] ] [ [ 100 ] [ 200 ] ] +
                                    # -> [ [ 101 102 103 ] [ 204 205 206 ] ]
```

#### エラーケース

互換性のない形状ではブロードキャストできずエラーとなる:

```ajisai
[ 1 2 3 ] [ 1 2 ] +                # エラー: [3] と [2] は互換性なし
```

### 2.6 「変化なしはエラー」原則

Ajisaiでは、ワードの実行結果が入力と同一である場合、それをエラーとして扱う。「何も変わらない操作」は意味のない操作であり、プログラマの意図しない動作を早期に検出するための設計原則である。

この原則が適用される場面:

| カテゴリ | 具体例 | 理由 |
|---------|--------|------|
| 構造操作 | `[ 1 ] REVERSE` | 1要素では反転しても変化なし |
| 構造操作 | `[ 1 2 1 ] REVERSE` | 回文は反転しても変化なし |
| ソート | `[ 1 2 3 ] SORT` | 既にソート済み |
| ソート | `[ 1 1 1 ] SORT` | 全要素が同一 |
| 形式変換 | `'hello' STR` | 既に文字列形式 |
| 形式変換 | `123 NUM` | 既に数値形式 |
| 形式変換 | `TRUE BOOL` | 既に真偽値形式 |
| 算術 | `[ 1 2 3 ] [ 0 ] +` | 0の加算は変化なし |
| 算術 | `[ 1 2 3 ] [ 1 ] *` | 1の乗算は変化なし |
| 文字列 | `[ '' ] CHARS` | 空文字列の分解は変化なし |

この原則は「プログラマを信頼する」というFORTH精神の継承ではなく、「意味のない操作を禁止する」というAjisai独自の設計判断である。

### 2.7 NIL

NILはAjisaiにおける「値の不在」を表すセンチネル値である。

#### 内部表現

```
data: [Fraction(0/0)]    （センチネル分数）
shape: []                 （スカラー）
display_hint: Nil
```

#### 空ブラケットの禁止

空ブラケット `[ ]` はエラーとなる。NILが必要な場合は `NIL` キーワードを使用する。

```ajisai
[ ]                                 # エラー: Empty vector is not allowed
NIL                                 # NIL（センチネル値 0/0）
[ 1 NIL 3 ]                        # NILを要素として持つVector
```

#### NILに対する操作

| 操作 | 結果 | 説明 |
|------|------|------|
| `NIL LENGTH` | `[ 0 ]` | 長さ0 |
| `NIL 'WORD' MAP` | `NIL` | NILをMAPしてもNIL |
| `NIL [ 42 ] : + ; FOLD` | `[ 42 ]` | 初期値がそのまま返る |
| `NIL => [ 0 ]` | `[ 0 ]` | Nil Coalescingで代替値 |
| `[ 42 ] => [ 0 ]` | `[ 42 ]` | 非NILはそのまま |

#### FILTERとNIL

FILTERで該当要素がない場合はNILを返す。Nil Coalescing演算子 `=>` と組み合わせてデフォルト値を設定できる。

```ajisai
[ 1 2 3 ] : [ 10 ] < NOT ; FILTER  # -> NIL（該当なし）
[ 1 2 3 ] : [ 10 ] < NOT ; FILTER => [ 0 ]
                                    # -> [ 0 ]（デフォルト値）
```

### 2.8 コメント

`#` 以降は行末までコメントとして扱われる。

```ajisai
[ 1 2 3 ] + # これはコメント
123#数値の直後でもコメントになる   # -> [ 123 ]
1/3#分数の後のコメント             # -> [ 1/3 ]
'#文字列内は保護される'            # -> '#文字列内は保護される'
```

`#` はトークン境界として機能するため、数値やリテラルの読み取りは `#` の直前で停止する。文字列リテラル内の `#` はコメントとして解釈されない。

---

## 3. 操作修飾子

### 3.1 操作対象モード

| 修飾子 | 名称 | 動作 |
|--------|------|------|
| `.` | スタックトップモード | スタック最上位の1要素に対して操作を適用（デフォルト） |
| `..` | スタック全体モード | スタック全体（0次元Vector）に対して操作を適用 |

ワード実行後、自動的にスタックトップモード（`.`）にリセットされる。

### 3.2 消費モード

| 修飾子 | 名称 | 動作 |
|--------|------|------|
| `,` | 消費モード | オペランドをスタックから消費する（デフォルト） |
| `,,` | 保持モード | オペランドをスタックに残したまま結果を追加する |

ワード実行後、自動的に消費モード（`,`）にリセットされる。

修飾子は順序非依存である: `.. ,,` と `,, ..` は同じ動作をする。

### 3.3 デフォルト消費原則

**すべてのワードはデフォルトで対象（オペランド）を消費する。** これはAjisaiにおける消費性の均一原則である。

元の値を保持したい場合は、保持モード `,,` で明示的に指定する。ワードごとに消費性が異なるという暗黙の例外は設けない。

```ajisai
# GET: 対象Vectorを消費し、取得した要素を返す
[ 10 20 30 ] [ 0 ] GET        # -> [ 10 ]
[ 10 20 30 ] [ 0 ] ,, GET     # -> [ 10 20 30 ] [ 10 ]  （保持モード）

# LENGTH: 対象Vectorを消費し、要素数を返す
[ 1 2 3 4 5 ] LENGTH           # -> [ 5 ]
[ 1 2 3 4 5 ] ,, LENGTH       # -> [ 1 2 3 4 5 ] [ 5 ]  （保持モード）

# 算術: 両オペランドを消費し、結果を返す
[ 1 2 3 ] [ 10 ] +            # -> [ 11 12 13 ]
[ 1 2 3 ] [ 10 ] ,, +         # -> [ 1 2 3 ] [ 10 ] [ 11 12 13 ]  （保持モード）
```

この原則により、プログラマは `,,` の有無だけで消費性を判断できる。ワードごとの暗記は不要になる。

#### スタック全体モード（`..`）での消費性

`..` モードでは操作対象が「スタック全体」になる。デフォルト消費原則はここでも同様に適用される。

```ajisai
# GET: スタック全体を消費し、取得した要素を返す
a b c [ 1 ] .. GET            # -> [ b ]
a b c [ 1 ] ,, .. GET         # -> a b c [ b ]  （保持モード）

# LENGTH: スタック全体を消費し、要素数を返す
1 2 3 4 5 .. LENGTH            # -> [ 5 ]
1 2 3 4 5 ,, .. LENGTH         # -> 1 2 3 4 5 [ 5 ]  （保持モード）

# REVERSE: スタック全体を消費し、反転結果を再配置する
a b c .. REVERSE               # -> c b a
```

#### 保持モード（`,,`）の範囲

`,,` はワードが消費するすべてのオペランドを保持する。対象Vectorのみ、あるいは引数Vectorのみを選択的に保持することはできない。

```ajisai
# TAKE: 対象Vectorと引数Vectorの両方を消費/保持する
[ 1 2 3 4 5 ] [ 3 ] TAKE      # -> [ 1 2 3 ]                      （両方消費）
[ 1 2 3 4 5 ] [ 3 ] ,, TAKE   # -> [ 1 2 3 4 5 ] [ 3 ] [ 1 2 3 ]  （両方保持）

# INSERT: 同上
[ 1 3 ] [ 1 2 ] INSERT         # -> [ 1 2 3 ]                       （両方消費）
[ 1 3 ] [ 1 2 ] ,, INSERT      # -> [ 1 3 ] [ 1 2 ] [ 1 2 3 ]       （両方保持）
```

---

## 4. 制御構造

### 4.1 コードブロック

`: コード ;` でコードブロック（遅延評価されるコード）を定義する。DEFでのワード定義やMAP/FILTER/FOLDの引数に使用する。

### 4.2 シェブロン分岐（ガード）

`>>` で条件、`>>` でアクション、`>>>` でデフォルトアクションを定義する多分岐構造。

```ajisai
:
  >> [ 0 ] <
  >> [ -1 ]
  >> [ 0 ] =
  >> [ 0 ]
  >>> [ 1 ]
; 'SIGN' DEF
```

### 4.3 パイプライン演算子

`==` はデータフローを視覚的に明示するためのno-opマーカーである。

```ajisai
[ 1 2 3 4 5 ]
  == : [ 2 ] * ; MAP
  == : [ 5 ] < NOT ; FILTER
  == [ 0 ] : + ; FOLD
```

### 4.4 Nil Coalescing演算子

`=>` は値がNILの場合に代替値を返す。

```ajisai
NIL => [ 0 ]       # -> [ 0 ]
[ 42 ] => [ 0 ]    # -> [ 42 ]
```

---

## 5. ワード分類

### 5.1 組み込みワード

組み込みワードは削除・上書きできない。以下のカテゴリに分類される:

- **操作対象指定**: `.` `..`
- **消費モード**: `,` `,,`
- **入力支援**: `'` `FRAME`
- **位置操作（0オリジン）**: `GET` `INSERT` `REPLACE` `REMOVE`
- **量操作**: `LENGTH` `TAKE`
- **Vector操作**: `SPLIT` `CONCAT` `REVERSE` `RANGE` `REORDER` `SORT`
- **定数**: `TRUE` `FALSE` `NIL`
- **文字列操作**: `CHARS` `JOIN`
- **形式変換**: `NUM` `STR` `BOOL` `CHR`
- **日時**: `NOW` `DATETIME` `TIMESTAMP`
- **算術**: `+` `-` `*` `/` `MOD` `FLOOR` `CEIL` `ROUND`
- **比較**: `=` `<` `<=`
- **論理**: `AND` `OR` `NOT`
- **高階関数**: `MAP` `FILTER` `FOLD`
- **入出力**: `PRINT`
- **音楽**: `SEQ` `SIM` `PLAY` `SLOT` `GAIN` `GAIN-RESET` `PAN` `PAN-RESET` `FX-RESET`
- **ワード管理**: `DEF` `DEL` `?`
- **制御フロー**: `TIMES` `WAIT` `>>` `>>>` `!` `==` `=>`
- **乱数**: `CSPRNG`
- **ハッシュ**: `HASH`
- **メタプログラミング**: `EXEC` `EVAL`

### 5.2 カスタムワード

`: コード ; '名前' DEF` でユーザーが定義するワード。ワード名は自動的に大文字に変換される。呼び出し深度制限（最大3）の対象となる。

---

## 6. 設計上の禁止事項

以下はAjisaiの設計に反するため、仕様として明確に禁止する:

1. **スタック操作ワード（DUP, SWAP, ROT, OVER等）の導入**: Ajisaiはこれらを持たない。同等の操作は `REORDER` や `.. GET` 等のVector操作で表現する
2. **次元制限（3）を超える構造の導入**
3. **呼び出し深度制限（3）を超える再帰チェーンの許容**
4. **型システムの導入**: すべての値は分数であり、型チェックは存在しない

---

## 変更履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| v0.1.0 | 2026-02-06 | 初期骨組み作成 |
| v0.1.1 | 2026-02-06 | 「変化なしはエラー」原則を追加 |
| v0.1.2 | 2026-02-06 | デフォルト消費原則を追加（GET/LENGTHの消費性を均一化） |
| v0.1.3 | 2026-02-06 | スタック全体モードでの消費性、保持モードの範囲を明確化 |
| v0.2.0 | 2026-02-06 | NIL、矩形制約、コメント、ブロードキャスト詳細、DisplayHint、Fraction型、呼び出し深度詳細、括弧表示規則を統合。Documentation/*.mdの内容を本仕様書に一本化 |
